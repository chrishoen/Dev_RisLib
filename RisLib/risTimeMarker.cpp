/*==============================================================================
==============================================================================*/

//******************************************************************************
//******************************************************************************
//******************************************************************************

#include "stdafx.h"

#include "risProgramTime.h"
#include "risTimeMarker.h"

namespace Ris
{

//******************************************************************************
//******************************************************************************
//******************************************************************************
//******************************************************************************
//******************************************************************************
//******************************************************************************

PeriodicTimeMarker::PeriodicTimeMarker()
{
   mTimeAtStartUS = 0.0;
   mTimeAtStopUS = 0.0;
   mStartFlag = false;
   mChangeCount = 0;
}

//******************************************************************************
//******************************************************************************
//******************************************************************************

void PeriodicTimeMarker::initialize(int aWindowSize)
{
   // All zero.
   mTimeAtStartUS = 0.0;
   mTimeAtStopUS = 0.0;
   mStartFlag = false;
   mChangeCount=0;

   // Initialize statistics.
   mStatistics.initialize(aWindowSize);
}

//******************************************************************************
//******************************************************************************
//******************************************************************************

void PeriodicTimeMarker::doStart()
{
   // Read start time from hardware.
   mTimeAtStartUS = Ris::getCurrentProgramTimeUS();

   // Set flag.
   mStartFlag=true;
}

//******************************************************************************
//******************************************************************************
//******************************************************************************

void PeriodicTimeMarker::doStop()
{
   // Read stop time from hardware.
   mTimeAtStopUS = Ris::getCurrentProgramTimeUS();

   // Calculate time difference.
   mTimeDifferenceUS = mTimeAtStopUS - mTimeAtStartUS;

   // Calculate statistics on delta time.
   if (mStartFlag)
   {
      mStatistics.put(mTimeDifferenceUS);

      if (mStatistics.mEndOfPeriod)
      {
         mChangeCount++;
      }
   }
}

//******************************************************************************
//******************************************************************************
//******************************************************************************
//******************************************************************************
//******************************************************************************
//******************************************************************************

TrialTimeMarker::TrialTimeMarker()
{
   mTimeAtStartUS = 0.0;
   mTimeAtStopUS = 0.0;
   mStartFlag = false;
}

//******************************************************************************
//******************************************************************************
//******************************************************************************

void TrialTimeMarker::startTrial(double aXLimit)
{
   mTimeAtStartUS = 0.0;
   mTimeAtStopUS = 0.0;
   mStartFlag = false;

   // Initialize statistics.
   mStatistics.startTrial(aXLimit);
}

void TrialTimeMarker::finishTrial()
{
   mStatistics.finishTrial();
}

//******************************************************************************
//******************************************************************************
//******************************************************************************

void TrialTimeMarker::doStart()
{
   // Read start time from hardware.
   mTimeAtStartUS = Ris::getCurrentProgramTimeUS();

   // Set flag.
   mStartFlag = true;
}

//******************************************************************************
//******************************************************************************
//******************************************************************************

void TrialTimeMarker::doStop()
{
   // Read stop time from hardware.
   mTimeAtStopUS = Ris::getCurrentProgramTimeUS();

   // Calculate time difference.
   mTimeDifferenceUS = mTimeAtStopUS - mTimeAtStartUS;

   // Calculate statistics on delta time.
   if (mStartFlag)
   {
      mStatistics.put(mTimeDifferenceUS);
   }
}

//******************************************************************************
//******************************************************************************
//******************************************************************************
}//namespace
